<div class="bg-kiosk">
  <div class="max-w-4xl mx-auto py-10 px-8" data-controller="test-form">

    <!-- ========== Progress ========== -->
    <div class="progress-kiosk mb-10">
      <div class="progress-step done"></div>
      <div class="progress-step active"></div>
      <div class="progress-step"></div>
    </div>

    <!-- ========== Step Header ========== -->
    <div class="text-center mb-12">
      <div class="subject-badge mb-6" style="background:<%= subject_color(@subject) %>;">
        <%= subject_icon(@subject) %> <%= @subject.name %>
      </div>
      
      <h1 class="heading-kiosk-1 mb-4">
        単元と設定を選んでください
      </h1>
      <p class="text-kiosk-body">横にスワイプして単元を選択 👉</p>
    </div>

    <%= form_with model: @test_sheet,
                  url: step2_submit_test_sheets_path,
                  method: :post,
                  data: { 
                    controller: "test-form",
                    action: "submit->test-form#handleSubmit"
                  } do |f| %>

      <%= f.hidden_field :subject_id, value: @subject.id %>

      <!-- ========== Unit Carousel ========== -->
      <div class="carousel-kiosk mb-12">
        <% @units.each do |unit| %>
          <label class="carousel-item">
            <input type="radio"
                   name="test_sheet[unit_id]"
                   value="<%= unit.id %>"
                   class="hidden"
                   data-test-form-target="unitRadio"
                   data-action="change->test-form#onUnitChange"
                   required>

            <div class="unit-card">
              <div class="unit-card-grade">高<%= unit.grade %></div>
              <div class="unit-card-title"><%= unit.name %></div>
              <div class="unit-card-count" style="color:<%= subject_color(@subject) %>;">
                <%= unit.question_count %>問
              </div>
            </div>
          </label>
        <% end %>
      </div>

      <!-- ========== Settings Panel ========== -->
      <div class="settings-panel mb-12">
        <h2 class="settings-title">⚙️ テスト設定</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

          <!-- Difficulty -->
          <div class="setting-item">
            <div class="setting-label">
              📊 難易度
            </div>
            <%= f.select :difficulty,
                difficulty_options_for_select_with_mix,
                {},
                class: "setting-select",
                data: { test_form_target: "difficultySelect",
                        action: "change->test-form#onDifficultyChange" }
            %>
          </div>

          <!-- Question Count -->
          <div class="setting-item">
            <div class="setting-label">
              🔢 問題数
            </div>
            <%= f.select :question_count,
                question_count_options,
                { selected: TestSheet::DEFAULT_QUESTION_COUNT },
                class: "setting-select",
                data: { test_form_target: "questionCountSelect" }
            %>
            <p class="mt-3 text-base" style="color: var(--text-light);"
               data-test-form-target="availableInfo">
              利用可能: 
              <span data-test-form-target="availableCount"
                    class="font-bold" style="color: var(--accent-blue);">-</span>問
            </p>
          </div>

        </div>

        <!-- Options -->
        <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">

          <!-- Show Hint -->
          <label class="option-checkbox-item">
            <%= f.check_box :include_hint,
                class: "option-checkbox",
                style: "accent-color:<%= subject_color(@subject) %>;" %>
            <span class="option-label">💡 ヒントを表示</span>
          </label>

          <!-- Show Answer -->
          <label class="option-checkbox-item">
            <%= f.check_box :include_answer,
                checked: TestSheet::DEFAULT_INCLUDE_ANSWER,
                class: "option-checkbox",
                style: "accent-color:<%= subject_color(@subject) %>;" %>
            <span class="option-label">✅ 解答を表示</span>
          </label>

        </div>
      </div>

      <!-- ========== Submit Button ========== -->
      <%= f.submit "🎯 テストを作成",
          class: "btn-neo btn-neo-green",
          data: { test_form_target: "submitButton" } %>

    <% end %>

    <!-- ========== Back Button ========== -->
    <div class="mt-8">
      <%= link_to step1_test_sheets_path,
          class: "btn-neo btn-neo-secondary" do %>
        ◀ 戻る
      <% end %>
    </div>

  </div>
</div>
